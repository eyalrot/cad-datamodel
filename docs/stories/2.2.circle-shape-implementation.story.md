# Story 2.2: Circle Shape Implementation

## Status
Ready for Review

## Story
**As a** developer,
**I want** to implement the Circle shape with full functionality including bounds calculation and transform support,
**so that** users can create and manipulate circular shapes in their CAD drawings.

## Acceptance Criteria
1. Circle shape can be created with valid parameters (cx, cy, radius)
2. Invalid parameters raise appropriate exceptions with clear error messages
3. Bounds calculation returns correct bounding box for circles
4. Circle is immutable after creation (no attribute modification allowed)
5. Transform matrices can be applied to create transformed circles
6. Factory pattern creates circles through ShapeFactory
7. Circle has complete type hints and passes mypy strict mode
8. Test coverage for Circle implementation exceeds 95%

## Tasks / Subtasks
- [x] Create Circle class implementation (AC: 1, 2, 4, 7)
  - [x] Create Circle class in cad_datamodel/shapes/circle.py
  - [x] Inherit from Shape base class
  - [x] Add circle-specific attributes: cx, cy, radius
  - [x] Implement validation for positive radius
  - [x] Ensure immutability through property setters
- [x] Implement bounds calculation (AC: 3)
  - [x] Override get_bounds() method
  - [x] Calculate bounding box considering transformation
  - [x] Account for circle's radius in all directions
  - [x] Return Bounds object with correct min/max points
- [x] Implement transform support (AC: 5)
  - [x] Override apply_transform() method
  - [x] Apply transformation to center point
  - [x] Note: radius does not change with translation/rotation
  - [x] Handle scaling transforms appropriately
- [x] Implement serialization methods (AC: 4, 7)
  - [x] Implement to_dict() for circle serialization
  - [x] Implement from_dict() class method for deserialization
  - [x] Include all circle-specific attributes in serialization
  - [x] Validate data during deserialization
- [x] Update ShapeFactory (AC: 6)
  - [x] Add ShapeType.CIRCLE enum value in core/types.py
  - [x] Add circle creation method in shapes/factory.py
  - [x] Register Circle class in factory mapping
  - [x] Add type validation for circle parameters
- [x] Update persistence layer for Circle support
  - [x] Add _circle_to_svg() method in persistence/svg.py
  - [x] Map Circle to SVG <circle> element
  - [x] Apply style attributes correctly
  - [x] Handle transform attribute if present
- [x] Write comprehensive unit tests (AC: 8)
  - [x] Create tests/unit/shapes/test_circle.py
  - [x] Test valid circle creation
  - [x] Test invalid parameter handling
  - [x] Test bounds calculation with and without transforms
  - [x] Test serialization/deserialization
  - [x] Test SVG export functionality
  - [x] Ensure 95%+ coverage for circle.py

## Dev Notes

### Previous Story Insights
From story 2.1 (Rectangle implementation):
- Shape base class is already implemented with immutability patterns
- Transform system uses numpy arrays for matrix operations
- Bounds calculation must account for transformed coordinates
- Style system is already in place and working
- SVG exporter pattern established for shape conversion

### Data Models
**Circle Class** [Source: architecture.md#4.3-Circle]
- Inherits from Shape base class
- Key attributes:
  - cx: float - Center X coordinate
  - cy: float - Center Y coordinate  
  - radius: float - Circle radius
- Must validate radius > 0

**Shape Base Class** [Source: architecture.md#4.1-Shape]
- Already implemented in cad_datamodel/shapes/shape.py
- Provides: id, type, layer_id, group_id, visible, locked, style, transform, metadata
- Abstract methods to implement: get_bounds(), to_dict(), from_dict()

### API Specifications
No specific API endpoints for this library implementation.

### Component Specifications
**ShapeType Enum** [Source: architecture.md#Section-3.2]
- Located in cad_datamodel/core/types.py
- Need to add CIRCLE = "circle" to the enum

**Bounds Calculation**
- Circle bounds = (cx - radius, cy - radius) to (cx + radius, cy + radius)
- Must apply transformation matrix to get final bounds
- Use existing Point and Bounds types from core/types.py

### File Locations
Based on project structure [Source: architecture.md#Section-9]:
- Circle implementation: `src/cad_datamodel/shapes/circle.py`
- Circle tests: `tests/unit/shapes/test_circle.py`
- Update factory: `src/cad_datamodel/shapes/factory.py`
- Update SVG exporter: `src/cad_datamodel/persistence/svg.py`
- Update types: `src/cad_datamodel/core/types.py`

### Testing Requirements
[Source: architecture.md#Section-13]
- Framework: pytest 8.3.0
- Location: tests/unit/shapes/
- Follow AAA pattern (Arrange, Act, Assert)
- Mock external dependencies if any
- Minimum 95% coverage requirement
- Use existing test patterns from test_rectangle.py

### Technical Constraints
- Python 3.9+ compatibility required
- Use numpy for any matrix operations
- Follow immutability patterns (properties, no setters)
- All public methods need complete type hints
- Must pass mypy strict mode
- Follow existing code style (Ruff formatted)

### Testing

**Test File Location**: `tests/unit/shapes/test_circle.py`

**Testing Standards**:
- Use pytest framework with fixtures
- Follow AAA pattern (Arrange, Act, Assert) 
- Test both positive and negative cases
- Mock dependencies where appropriate
- Ensure deterministic tests (no randomness)
- Use parametrized tests for multiple test cases
- Follow naming convention: test_<method>_<scenario>_<expected_result>

**Specific Test Requirements**:
- Test circle creation with valid parameters
- Test validation errors for invalid parameters (negative radius, invalid types)
- Test bounds calculation accuracy
- Test transform application
- Test serialization round-trip (to_dict/from_dict)
- Test SVG export generates correct <circle> element
- Test immutability (attempts to modify attributes should fail)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-05 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-08-05 | 1.1 | Approved and ready for development | Bob (Scrum Master) |
| 2025-08-05 | 1.2 | All tasks completed, status changed to Ready for Review | James (Dev Agent) |

## Dev Agent Record
### Agent Model Used
James (Full Stack Developer) - Claude Opus 4

### Debug Log References
- ShapeType.CIRCLE already existed in core/types.py enum
- Circle implementation follows same pattern as Rectangle
- Bounds calculation uses cardinal points for accurate transformed bounds
- All tests pass (21 new tests - 16 for Circle, 5 for SVG export)
- 100% code coverage achieved for circle.py
- Type checking passes with mypy --strict

### Completion Notes List
- Circle shape fully implemented with all required features
- Parameter validation raises ShapeValidationError for non-positive radius
- Immutability enforced through read-only properties
- Bounds calculation correctly handles transformations by checking cardinal points
- Transform support creates new instances maintaining immutability
- Factory pattern integrated with create_circle() convenience method
- SVG export correctly maps to <circle> element with proper attributes
- Comprehensive test suite with 100% code coverage (exceeds 95% requirement)
- All acceptance criteria met

### File List
- cad_datamodel/shapes/circle.py (created) - Circle shape implementation
- cad_datamodel/shapes/factory.py (modified) - Added Circle support to factory
- cad_datamodel/persistence/svg.py (modified) - Added Circle SVG export
- cad_datamodel/shapes/__init__.py (modified) - Added Circle export
- tests/unit/shapes/test_circle.py (created) - Comprehensive test suite for Circle
- tests/unit/persistence/test_svg_circle.py (created) - SVG export tests for Circle


## QA Results